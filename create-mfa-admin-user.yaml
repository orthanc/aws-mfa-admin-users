---
- hosts: localhost
  vars:
    mfa_required: true
  tasks:
    - name: "Ansible User"
      iam:
        iam_type: user
        name: "ansible-admin"
        access_key_state: create
        state: present
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: ansible_user_info
      no_log: True
    - name: "vault.yaml"
      template:
        src: templates/vault.yaml.j2
        dest: "{{ playbook_dir }}/inventory/ansible-admin/group_vars/aws_control/aws_creds_vault.yaml"
        mode: 0600
      when: ansible_user_info.changed
    - name: "Load Vault"
      include_vars:
        file: "{{ playbook_dir }}/inventory/ansible-admin/group_vars/aws_control/aws_creds_vault.yaml"
        name: aws_creds_vault
      no_log: True
    - name: "User Policies"
      iam_policy:
        iam_type: user
        iam_name: "ansible-admin"
        policy_name: "{{ item }}"
        policy_json: "{{ lookup('template', 'templates/iam_policy/'+item+'.json.j2') }}"
        state: present
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      with_items:
        - require_https
        - require_mfa
        - full_access
    - name: "vars.yaml"
      template:
        src: templates/vars.yaml.j2
        dest: "{{ playbook_dir }}/inventory/ansible-admin/group_vars/aws_control/aws_creds_vars.yaml"
    - debug:
        msg: |
          ansible-admin user created in AWS account, this user must use MFA to get a temporary STS token.
          When authenticated with a MFA token this user has full admin rights to the account.
          
          You must assign an MFA device to the ansible-admin user in the AWS console. Ensure the ARN is correct in
          {{ playbook_dir }}/inventory/ansible-admin/group_vars/aws_control/aws_creds_vars.yaml
          
          API Access Keys for this user are in:
          {{ playbook_dir }}/inventory/ansible-admin/group_vars/aws_control/aws_creds_vault.yaml
          
          You really should encrypt this file with ansible-vault.
